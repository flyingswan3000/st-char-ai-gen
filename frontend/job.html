<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>任務狀態 - SillyTavern 角色卡</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-100 text-slate-900">
    <header class="bg-white shadow-sm">
      <div class="mx-auto flex max-w-6xl flex-col gap-2 px-4 py-6 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-2xl font-semibold">SillyTavern 任務狀態</h1>
          <p class="text-sm text-slate-500">查看 LLM 呼叫的即時輸出、最終結果與原始輸入。</p>
        </div>
        <a href="/" class="text-sm text-indigo-600 hover:underline">返回首頁</a>
      </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-6">
      <div id="pageStatus" class="mb-4 text-sm text-slate-600"></div>
      <div class="grid gap-6 lg:grid-cols-2">
        <section class="rounded-lg bg-white p-5 shadow">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-xl font-semibold text-slate-800">任務資訊</h2>
              <p class="text-sm text-slate-500">包含各階段時間及 token 使用量。</p>
            </div>
            <button id="reloadJob" class="rounded border border-slate-300 px-3 py-1 text-sm text-slate-600 hover:border-indigo-400 hover:text-indigo-500">重新載入</button>
          </div>
          <div id="jobMeta" class="mt-4 space-y-2 text-sm text-slate-700">
            <p>載入中...</p>
          </div>
          <div class="mt-6">
            <h3 class="text-sm font-semibold text-slate-700">原始輸入</h3>
            <div class="mt-2 max-h-96 overflow-auto rounded border border-slate-200 bg-slate-50 p-3">
              <pre id="jobInput" class="whitespace-pre-wrap text-xs text-slate-700">尚未載入</pre>
            </div>
          </div>
        </section>

        <section class="rounded-lg bg-white p-5 shadow">
          <div>
            <h2 class="text-xl font-semibold text-slate-800">串流輸出</h2>
            <p class="text-sm text-slate-500">若任務仍在進行中會持續更新。</p>
            <div class="mt-3 max-h-64 overflow-auto rounded border border-slate-200 bg-slate-50 p-3">
              <pre id="streamOutput" class="whitespace-pre-wrap text-xs text-slate-800">尚未收到任何輸出。</pre>
            </div>
          </div>
          <div class="mt-6">
            <h2 class="text-xl font-semibold text-slate-800">產生結果</h2>
            <p class="text-sm text-slate-500">完成後可直接下載 SillyTavern JSON。</p>
            <div class="mt-3 space-y-3">
              <div id="resultInfo" class="rounded border border-slate-200 bg-slate-50 p-3 text-sm text-slate-700">尚未完成。</div>
              <button id="downloadResult" class="w-full rounded border border-slate-300 px-4 py-2 text-sm text-slate-600 hover:border-indigo-400 hover:text-indigo-500 disabled:cursor-not-allowed disabled:border-slate-200 disabled:text-slate-300" disabled>
                下載 JSON
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const jobId = params.get('id');
      const pageStatus = document.getElementById('pageStatus');
      const jobMeta = document.getElementById('jobMeta');
      const jobInput = document.getElementById('jobInput');
      const streamOutput = document.getElementById('streamOutput');
      const resultInfo = document.getElementById('resultInfo');
      const downloadBtn = document.getElementById('downloadResult');
      const reloadBtn = document.getElementById('reloadJob');

      const escapeHtml = (value = '') =>
        String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const statusLabels = {
        pending: '等待中',
        running: '進行中',
        completed: '完成',
        failed: '失敗',
      };

      let streamText = '';
      let streamOffset = 0;
      let eventSource = null;
      let latestMeta = null;

      const setPageStatus = (message, type = 'info') => {
        const colorMap = {
          info: 'text-slate-600',
          success: 'text-emerald-600',
          error: 'text-rose-600',
        };
        pageStatus.className = `mb-4 text-sm ${colorMap[type] ?? 'text-slate-600'}`;
        pageStatus.textContent = message;
      };

      const formatTime = (value) => (value ? new Date(value).toLocaleString() : '-');

      const renderMeta = (meta) => {
        if (!meta) {
          jobMeta.innerHTML = '<p class="text-sm text-rose-600">找不到任務。</p>';
          return;
        }
        const statusText = statusLabels[meta.status] ?? meta.status;
        const usage = meta.token_usage
          ? Object.entries(meta.token_usage)
              .map(([key, value]) => `${key}: ${value}`)
              .join(' / ')
          : '尚無資料';
        const lines = [
          `<p><span class="font-medium">ID：</span>${escapeHtml(meta.id)}</p>`,
          `<p><span class="font-medium">供應商：</span>${escapeHtml(meta.provider)}</p>`,
          `<p><span class="font-medium">狀態：</span>${escapeHtml(statusText)}</p>`,
          `<p><span class="font-medium">建立時間：</span>${escapeHtml(formatTime(meta.created_at))}</p>`,
          `<p><span class="font-medium">開始時間：</span>${escapeHtml(formatTime(meta.started_at))}</p>`,
          `<p><span class="font-medium">完成時間：</span>${escapeHtml(formatTime(meta.completed_at))}</p>`,
          `<p><span class="font-medium">Token 使用量：</span>${escapeHtml(usage)}</p>`,
        ];
        if (meta.error) {
          lines.push(`<p class="text-rose-600">錯誤：${escapeHtml(meta.error)}</p>`);
        }
        jobMeta.innerHTML = lines.join('');
      };

      const renderInput = (text) => {
        jobInput.textContent = text || '(無內容)';
      };

      const renderStream = (text) => {
        streamOutput.textContent = text || '尚未收到任何輸出。';
      };

      const renderResult = (result) => {
        if (!result) {
          resultInfo.textContent = '尚未完成。';
          downloadBtn.disabled = true;
          return;
        }
        const summaryLines = [
          `名稱：${result?.data?.name ?? result?.name ?? '-'}`,
          `標籤：${(result?.data?.tags ?? result?.tags ?? []).join(', ') || '-'}`,
          `描述長度：${(result?.description ?? '').length}`,
        ];
        resultInfo.innerHTML = `
          <div class="space-y-1 text-sm text-slate-700">
            ${summaryLines.map((line) => `<p>${escapeHtml(line)}</p>`).join('')}
          </div>
          <div class="mt-3 max-h-64 overflow-auto rounded border border-slate-200 bg-white p-3">
            <pre class="whitespace-pre text-xs text-slate-800">${escapeHtml(JSON.stringify(result, null, 2))}</pre>
          </div>
        `;
        downloadBtn.disabled = false;
      };

      const appendStream = (chunk) => {
        streamText += chunk;
        renderStream(streamText);
      };

      const connectStream = () => {
        if (!jobId) return;
        if (eventSource) {
          eventSource.close();
        }
        eventSource = new EventSource(`/api/jobs/${jobId}/stream?offset=${streamOffset}`);
        eventSource.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            const newOffset = Number(event.lastEventId);
            if (!Number.isNaN(newOffset) && newOffset > streamOffset) {
              streamOffset = newOffset;
            }
            if (data.type === 'chunk') {
              appendStream(data.content || '');
            } else if (data.type === 'status') {
              if (data.status === 'completed') {
                setPageStatus('任務已完成。', 'success');
              } else if (data.status === 'failed') {
                setPageStatus(`任務失敗：${data.error || '未知錯誤'}`, 'error');
              }
              if (eventSource) {
                eventSource.close();
              }
              loadJobDetail();
            }
          } catch (error) {
            console.error('解析 SSE 內容失敗', error);
          }
        };
        eventSource.onerror = () => {
          if (eventSource) {
            eventSource.close();
          }
          setTimeout(() => {
            if (latestMeta && ['pending', 'running'].includes(latestMeta.status)) {
              connectStream();
            }
          }, 2000);
        };
      };

      const loadJobDetail = async () => {
        if (!jobId) {
          setPageStatus('網址缺少 id 參數', 'error');
          jobMeta.innerHTML = '<p class="text-sm text-rose-600">請返回首頁重新建立任務。</p>';
          return;
        }
        try {
          const response = await fetch(`/api/jobs/${jobId}`);
          if (!response.ok) throw new Error('無法取得任務資料');
          const detail = await response.json();
          latestMeta = detail.meta;
          streamText = detail.stream_text || '';
          streamOffset = detail.stream_offset || 0;
          renderMeta(detail.meta);
          renderInput(detail.input_text);
          renderStream(streamText);
          renderResult(detail.result);
          if (detail.meta.status === 'completed') {
            setPageStatus('任務已完成，可下載結果。', 'success');
            downloadBtn.disabled = false;
          } else if (detail.meta.status === 'failed') {
            setPageStatus(`任務失敗：${detail.meta.error || '未知錯誤'}`, 'error');
          } else {
            setPageStatus('任務進行中，等待 LLM 輸出...', 'info');
            connectStream();
          }
        } catch (error) {
          console.error(error);
          setPageStatus(error.message || '讀取失敗', 'error');
          jobMeta.innerHTML = '<p class="text-sm text-rose-600">無法取得任務資料。</p>';
        }
      };

      downloadBtn.addEventListener('click', () => {
        if (!jobId || downloadBtn.disabled) return;
        window.location.href = `/api/jobs/${jobId}/download`;
      });

      reloadBtn.addEventListener('click', loadJobDetail);

      loadJobDetail();
    </script>
  </body>
</html>
